FROM nginx:alpine3.20

# 1. 安装必要工具 (Alpine 版更轻量，适合 Choreo)
RUN apk update && apk upgrade && \
    apk add --no-cache wget unzip iproute2 curl bash

# 2. 设置工作目录到可写位置的软连接或直接使用应用目录
WORKDIR /home/choreo/app

# 3. 复制配置和脚本
COPY nginx.conf /etc/nginx/nginx.conf
COPY entrypoint.sh ./

# 4. 下载并配置 V2-ray (在构建阶段完成，避免运行时的只读限制)
RUN wget -O temp.zip $(wget -qO- "https://api.github.com/repos/v2fly/v2ray-core/releases/latest" | grep -m1 -o "https.*linux-64.*zip") && \
    unzip temp.zip v2ray geoip.dat geosite.dat && \
    mv v2ray v && \
    rm -f temp.zip && \
    chmod -v 755 v entrypoint.sh && \
    # 写入 Base64 配置到文件
    echo 'ewogICAgImxvZyI6ewogICAgICAgICJsb2dsZXZlbCI6Indhcm5pbmciLAogICAgICAgICJhY2Nl\
c3MiOiIvZGV2L251bGwiLAogICAgICAgICJlcnJvciI6Ii9kZXYvbnVsbCIKICAgIH0sCiAgICAi\
aW5ib3VuZHMiOlsKICAgICAgICB7CiAgICAgICAgICAgICJwb3J0IjoxMDAwMCwKICAgICAgICAg\
ICAgInByb3RvY29sIjoidm1lc3MiLAogICAgICAgICAgICAibGlzdGVuIjoiMTI3LjAuMC4xIiwK\
ICAgICAgICAgICAgInNldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAiY2xpZW50cyI6WwogICAg\
ICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgImlkIjoiVVVJRCIsCiAg\
ICAgICAgICAgICAgICAgICAgICAgICJhbHRlcklkIjowCiAgICAgICAgICAgICAgICAgICAgfQog\
ICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICAic3RyZWFtU2V0dGlu\
Z3MiOnsKICAgICAgICAgICAgICAgICJuZXR3b3JrIjoid3MiLAogICAgICAgICAgICAgICAgIndz\
U2V0dGluZ3MiOnsKICAgIC2icGF0aCI6IlZNRVNTX1dTUEFUSCIKICAgICAgICAgICAgICAgIH0K\
ICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICAicG9ydCI6MjAw\
MDAsCiAgICAgICAgICAgICJwcm90b2NvbCI6InZsZXNzIiwKICAgICAgICAgICAgImxpc3RlbiI6\
IjEyNy4wLjAuMSIsCiAgICAgICAgICAgICJzZXR0aW5ncyI6ewogICAgICAgICAgICAgICAgImNs\
aWVudHMiOlsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJp\
ZCI6IlVVSUQiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgXSwKICAgICAg\
ICAgICAgICAgICJkZWNyeXB0aW9uIjoibm9uZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAg\
InNldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAibmV0d29yayI6IndzIiwKICAgICAgICAgICAg\
ICAgICJ3c1NldHRpbmdzIjp7CiAgICAgICAgICAgICAgICAgICAgInBhdGgiOiJWTEVTU19XU1BB\
VEgiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICBdLAogICAg\
Im91dGJvdW5kcyI6WwogICAgICAgIHsKICAgICAgICAgICAgInByb3RvY29sIjoiZnJlZWRvbSIs\
CiAgICAgICAgICAgICJzZXR0aW5ncyI6ewoKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIF0s\
CiAgICAiZG5zIjp7CiAgICAgICAgInNlcnZlcnMiOlsKICAgICAgICAgICAgIjguOC44LjgiLAog\
ICAgICAgICAgICAiOC44LjQuNCIsCiAgICAgICAgICAgICJsb2NhbGhvc3QiCiAgICAgICAgXQog\
ICAgfQp9Cg==' > config

# 5. 适配 Choreo 权限限制 (核心)
RUN addgroup -g 10001 choreo && \
    adduser -u 10001 -G choreo -s /bin/sh -D choreo && \
    # 授权 Nginx 必要目录给非 root 用户
    chown -R 10001:10001 /etc/nginx /var/cache/nginx /var/log/nginx /var/run /home/choreo/app && \
    # 修改 Nginx 进程文件位置
    touch /var/run/nginx.pid && \
    chown 10001:10001 /var/run/nginx.pid

# 6. 切换用户
USER 10001

# 7. 暴露端口 (Choreo 建议使用 >1024 端口，默认 8080)
EXPOSE 8080

ENTRYPOINT [ "./entrypoint.sh" ]
